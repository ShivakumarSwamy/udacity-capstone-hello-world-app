version: 2.1

orbs:
  slack: circleci/slack@4.3.1
  docker: circleci/docker@1.5.0
  helm: circleci/helm@1.2.0

executors:
  cimg-openjdk-11:
    docker:
      - image: cimg/openjdk:11.0

commands:

  slack-notify-fail:
    steps:
      - slack/notify:
          event: fail
          template: basic_fail_1

  slack-notify-pass:
    steps:
      - slack/notify:
          event: pass
          template: basic_success_1

jobs:
  build-test-analyze:
    docker:
      - image: circleci/openjdk:11.0.8-jdk
    steps:
      - checkout
      - run: ./gradlew build test sonarqube
      - slack-notify-fail
#  lint-dockerfile:
#    docker:
#      - image: circleci/node:13.8.0
#    steps:
#      - checkout
#      - docker/dockerlint:
#          treat-warnings-as-errors: true
#      - slack-notify-fail

  build-push-image-dev:
    docker:
      - image: circleci/openjdk:11.0.8-jdk
    steps:
      - checkout
      - run: ./gradlew jib
      - slack-notify-fail

  install-lint-dry-run-helm-v3:
    docker:
      - image: cimg/base:stable-20.04
    steps:
      - checkout
      - helm/install-helm-client:
          version: v3.0.0
      - run: helm install --generate-name --dry-run ./micro-service
      - slack-notify-fail

workflows:
  app:
    jobs:
#      - build-test-analyze:
#          context:
#            - sonar-secrets
#            - slack-secrets
#      - docker/hadolint
#      - lint-dockerfile:
#          requires:
#            - build-test-analyze
#          context:
#            - slack-secrets
#      - install-lint-dry-run-helm-v3:
#          context:
#            - slack-secrets
#          requires:
#            - build-test-analyze
      - docker/publish:
          after_build:
            - slack-notify-fail
          after_checkout:
            - run: ./gradlew build
            - setup_remote_docker
          image: udacity-capstone-hello-world-app
          executor: cimg-openjdk-11
          context:
            - docker-secrets
            - slack-secrets

#      - build-push-image-dev:
#          requires:
#            - build-test-analyze
#          context:
#            - docker-secrets
#            - slack-secrets
